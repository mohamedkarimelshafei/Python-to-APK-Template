name: Build Kivy Android APK In Debug Mode

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx2048m"

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9' # cython >3.9 has no long integer support

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev libssl-dev \
            curl unzip openjdk-17-jdk libltdl-dev

      - name: Install Buildozer and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install buildozer cython==0.29.33 kivy kivymd
          pip install python-for-android

      - name: Build APK with Buildozer
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "Checking versions..."
          java -version
          python --version
          buildozer --version

          export BUILDODER_ALLOW_PLATFORM_EXEC=1
          export USE_COLORS=0

          # Build debug APK
          buildozer -v android debug 2>&1 | tee buildozer.log

          # Copy any APKs to bin/ for artifact upload
          mkdir -p bin
          find . -name "*.apk" -exec cp {} bin/ \; 2>/dev/null || true

      - name: Check if APK was built
        id: check-build
        run: |
          if ls bin/*.apk 1> /dev/null 2>&1; then
            echo "BUILD_FINAL_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "Found APK files:"
            ls -la bin/
          else
            echo "BUILD_FINAL_SUCCESS=false" >> $GITHUB_OUTPUT
            echo "Didn't find APK files."
          fi

      - name: Upload APK artifact
        if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kivy-app-apk
          path: bin/*.apk
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            buildozer.log
          retention-days: 7
